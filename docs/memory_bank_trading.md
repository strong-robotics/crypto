| Тип операции | Инициатор | Когда срабатывает | Предварительные проверки | Основные шаги |
| --- | --- | --- | --- | --- |
| Auto-buy | Analyzer (`buy_real` с `source='auto_buy'`) | Токен прошёл фильтры и достиг точки входа | `wallet_id IS NULL`, нет открытой позиции, есть реальные SWAP, свободный кошелёк | Лочим токен → выбираем кошелёк/сумму → honeypot test-sell → покупка через Jupiter → запись entry_* в `wallet_history`, привязка кошелька |
| Auto-sell | Analyzer (`sell_real` с `source='auto_sell'`) | Достигнут TARGET_RETURN или сработало защитное условие (zero-liquidity, итерации и т.д.) | Открытая запись в `wallet_history`, токен привязан к кошельку | Лочим журнал → продаём весь объём через Jupiter (с ретраями) → обновляем exit_*, сбрасываем `wallet_id`, архивируем токен |
| Manual Buy (force-buy) | Пользователь / API (`buy_real` с `source='force_buy'`) | Нужно войти вручную, обходя решения AI | Те же проверки, что auto-buy: нет позиции, рынок живой, есть кошелёк | Повторяет pipeline auto-buy; `source` меняется для логов, паттерн-фильтр оператор обходил вручную |
| Manual Sell (force-sell) | Пользователь / API (`sell_real` с `source='force_sell'`) | Надо срочно закрыть позицию вне зависимости от условий стратегии | Требуется открытая позиция (иначе токен просто архивируется) | Вызов `sell_real` без проверки таргетов: сразу продаём, фиксируем exit_*, освобождаем кошелёк, архивируем токен |

| Условие / событие | Источник (кто инициирует) | Предварительные проверки | Действия при архивации |
| --- | --- | --- | --- |
| Штатная продажа (auto / manual / force) | `sell_real`, `force_sell` — `server/_v2_buy_sell.py:1000-1375` | В `wallet_history` есть открытая позиция; после сделки кошелёк освобождён (`wallet_id=NULL`). | Обновляем exit_* в `wallet_history`, очищаем `wallet_id`, вызываем `archive_token` → запись переезжает в `tokens_history`, метрики/трейды в *_history. |
| Zero-liquidity / «плоский» график | `JupiterAnalyzerV3` — `server/_v3_analyzer_jupiter.py:980-1016` | Последние `ZERO_TAIL_CONSEC_SEC` секунд цена/мкап нули или `_detect_liquidity_withdraw` вернул flat; позиция может быть открыта. | `finalize_token_sale` закрывает позицию по $0, освобождает кошелёк, затем `archive_token`. |
| Withdraw или долгий `empty_streak` в live-trades | `LiveTradesReaderV3` — `server/_v3_live_trades.py:360-438` | Нет открытой позиции; либо пришёл `withdraw`, либо `empty_streak` ≥ порога. | `mark_history_ready` → проверка на отсутствие открытой позиции → `archive_token`. |
| Нет пары / нет входа слишком долго | `_v3_cleaner` (вызов из `JupiterScheduler`) — `server/_v3_cleaner.py`, `server/_v3_jupiter_scheduler.py:132-151` | 1) `token_pair` пустой/равен адресу и метрики прожили ≥ `older_than_sec`; либо 2) пара есть, но в `wallet_history` нет записей дольше `CLEANER_NO_ENTRY_*`. | Cleaner удаляет токен, его метрики и трейды из «живых» таблиц (жёсткая очистка). |
| Покупка провалилась (Jupiter route/slippage) | `buy_real` — `server/_v2_buy_sell.py:1520-1570` | Покупка не выполнена, позиция ещё не открыта, ошибка соответствует route/slippage. | Токен помечается `pattern_segment_decision='not'`, вызывается `archive_token`, чтобы он исчез из активного списка. |
| Исторический импорт трейдов (backfill) | `_v2_trades_history.py:320-344` | После пагинации нашли `withdraw` или покрыли весь диапазон метрик; открытой позиции нет. | `mark_history_ready` → `archive_token`. |
| Ручные/CLI вызовы | `server/_v3_token_archiver.py`, `archive_tokens` и т.п. | Всегда проверяется, что нет открытой позиции (`wallet_history.exit_iteration IS NULL`). | Данные токена + метрики/трейды копируются в *_history и удаляются из «живых» таблиц. |

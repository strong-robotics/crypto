# üõ°Ô∏è –ë–µ–∑–ø–µ—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è - –ó–∞—Ö–∏—Å—Ç –¥–∞–Ω–∏—Ö

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö

**–í–°–Ü –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ!** –ú—ñ–≥—Ä–∞—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–∞–Ω—ñ –∑—ñ —Å—Ç–∞—Ä–∏—Ö —Ç–∞–±–ª–∏—Ü—å/–ø–æ–ª—ñ–≤ —É –Ω–æ–≤—ñ.

---

## üìã –©–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:

### 1. ‚úÖ –î–∞–Ω—ñ –∑ `tokens.sim_*` ‚Üí `wallet_history`
- –í—ñ–¥–∫—Ä–∏—Ç—ñ –ø–æ–∑–∏—Ü—ñ—ó (sim_buy_iteration IS NOT NULL, sim_sell_iteration IS NULL)
- –ó–∞–∫—Ä–∏—Ç—ñ –ø–æ–∑–∏—Ü—ñ—ó (sim_buy_iteration IS NOT NULL, sim_sell_iteration IS NOT NULL)
- –í—Å—ñ —Å—É–º–∏, —Ü—ñ–Ω–∏, —ñ—Ç–µ—Ä–∞—Ü—ñ—ó

### 2. ‚úÖ –î–∞–Ω—ñ –∑ `sim_wallets` ‚Üí `wallets`
- –í—Å—ñ –∫–æ—à–µ–ª—å–∫–∏ –∑ –±–∞–ª–∞–Ω—Å–∞–º–∏
- –ü—Ä–∏–±—É—Ç–∫–∏ —Ç–∞ –∞–∫—Ç–∏–≤–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó

### 3. ‚úÖ –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ (–¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è)
- `sim_plan_sell_iteration` ‚Üí `plan_sell_iteration`
- `sim_plan_sell_price_usd` ‚Üí `plan_sell_price_usd`
- `sim_cur_income_price_usd` ‚Üí `cur_income_price_usd`
- `real_wallet_id` ‚Üí `wallet_id`

### 4. ‚úÖ –¢–∞–±–ª–∏—Ü—è `sim_wallet_history` ‚Üí `wallet_history`
- –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è (–≤—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è)

---

## ‚ö†Ô∏è –©–æ –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è (—Ç—ñ–ª—å–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –¥–∞–Ω—ñ –≤–∂–µ –º—ñ–≥—Ä–æ–≤–∞–Ω—ñ):

### 1. –ö–æ–ª–æ–Ω–∫–∏ `sim_*` –≤ —Ç–∞–±–ª–∏—Ü—ñ `tokens`
- **–ü–ï–†–ï–î –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º:** –≤—Å—ñ –¥–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º—ñ–≥—Ä—É—é—Ç—å—Å—è –≤ `wallet_history`
- –í–∏–¥–∞–ª—è—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó

### 2. –¢–∞–±–ª–∏—Ü—è `sim_wallets`
- **–ü–ï–†–ï–î –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º:** –≤—Å—ñ –¥–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º—ñ–≥—Ä—É—é—Ç—å—Å—è –≤ `wallets`
- –í–∏–¥–∞–ª—è—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó

---

## üîç –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∞–Ω–∏—Ö –ü–ï–†–ï–î –º—ñ–≥—Ä–∞—Ü—ñ—î—é

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
python3 server/tools/check_data_before_migration.py
```

–¶–µ–π —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ:
- –°–∫—ñ–ª—å–∫–∏ –ø–æ–∑–∏—Ü—ñ–π —É `sim_*` –ø–æ–ª—è—Ö
- –°–∫—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å—ñ–≤ —É `sim_wallets`
- –ß–∏ –±—É–¥—É—Ç—å –¥–∞–Ω—ñ –≤—Ç—Ä–∞—á–µ–Ω—ñ

---

## üîí –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∫–∞–ø—É (–û–ë–û–í'–Ø–ó–ö–û–í–û!)

```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–≤–Ω–∏–π –±–µ–∫–∞–ø –ë–î
pg_dump -h localhost -U your_user -d crypto_db -F c -f backup_before_migration_$(date +%Y%m%d_%H%M%S).dump

# –ê–±–æ SQL dump
pg_dump -h localhost -U your_user -d crypto_db -f backup_before_migration_$(date +%Y%m%d_%H%M%S).sql
```

**–ù–∞–≤—ñ—Ç—å —è–∫—â–æ –º—ñ–≥—Ä–∞—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞, –±–µ–∫–∞–ø - —Ü–µ –≤–∞—à–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞!**

---

## üöÄ –ö—Ä–æ–∫ 3: –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π

### –í–∞—Ä—ñ–∞–Ω—Ç –ê: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑ –∑–º—ñ–Ω (dry-run)
python3 server/tools/apply_refactor_migrations.py --dry-run

# –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º
python3 server/tools/apply_refactor_migrations.py

# –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
python3 server/tools/apply_refactor_migrations.py --force
```

### –í–∞—Ä—ñ–∞–Ω—Ç –ë: –í—Ä—É—á–Ω—É (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å)

```bash
# 1. Data migration (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º—ñ–≥—Ä—É—î –¥–∞–Ω—ñ)
psql -h localhost -U your_user -d crypto_db -f server/migrations/20251106_data_migration.sql

# 2. –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
psql -h localhost -U your_user -d crypto_db -f server/migrations/rename_sim_wallet_history_to_wallet_history.sql

# 3. –û—á–∏—â–µ–Ω–Ω—è tokens (–≤–∏–¥–∞–ª–µ–Ω–Ω—è sim_* –ø–æ–ª—ñ–≤)
psql -h localhost -U your_user -d crypto_db -f server/migrations/20251106_tokens_cleanup.sql

# 4. –í–∏–¥–∞–ª–µ–Ω–Ω—è sim_wallets
psql -h localhost -U your_user -d crypto_db -f server/migrations/20251106_drop_sim_wallets.sql
```

---

## ‚úÖ –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ—Å–ª—è –º—ñ–≥—Ä–∞—Ü—ñ—ó

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –¥–∞–Ω—ñ –º—ñ–≥—Ä–æ–≤–∞–Ω—ñ
python3 server/tools/check_data_before_migration.py
```

–ü—ñ—Å–ª—è –º—ñ–≥—Ä–∞—Ü—ñ—ó —Å–∫—Ä–∏–ø—Ç –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–∫–∞–∑–∞—Ç–∏:
- ‚úÖ 0 –ø–æ–∑–∏—Ü—ñ–π —É `sim_*` –ø–æ–ª—è—Ö
- ‚úÖ 0 –∑–∞–ø–∏—Å—ñ–≤ —É `sim_wallets`
- ‚úÖ –î–∞–Ω—ñ –≤ `wallet_history` —Ç–∞ `wallets`

---

## üîÑ –í—ñ–¥–∫–∞—Ç (—è–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ë–î –∑ –±–µ–∫–∞–ø—É
pg_restore -h localhost -U your_user -d crypto_db -c backup_before_migration_*.dump

# –ê–±–æ –∑ SQL dump
psql -h localhost -U your_user -d crypto_db < backup_before_migration_*.sql
```

---

## üìä –ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π

1. ‚úÖ **20251106_data_migration.sql** - –º—ñ–≥—Ä—É—î –¥–∞–Ω—ñ (–ë–ï–ó–ü–ï–ß–ù–û)
2. ‚úÖ **rename_sim_wallet_history_to_wallet_history.sql** - –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è (–ë–ï–ó–ü–ï–ß–ù–û)
3. ‚úÖ **20251106_tokens_cleanup.sql** - –≤–∏–¥–∞–ª–µ–Ω–Ω—è sim_* –ø–æ–ª—ñ–≤ (–ë–ï–ó–ü–ï–ß–ù–û, –¥–∞–Ω—ñ –≤–∂–µ –º—ñ–≥—Ä–æ–≤–∞–Ω—ñ)
4. ‚úÖ **20251106_drop_sim_wallets.sql** - –≤–∏–¥–∞–ª–µ–Ω–Ω—è sim_wallets (–ë–ï–ó–ü–ï–ß–ù–û, –¥–∞–Ω—ñ –≤–∂–µ –º—ñ–≥—Ä–æ–≤–∞–Ω—ñ)

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏

1. **–ú—ñ–≥—Ä–∞—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞** - –¥–∞–Ω—ñ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
2. **–ë–µ–∫–∞–ø –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π** - –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
3. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—î—é** - –∑–∞–≤–∂–¥–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `check_data_before_migration.py`
4. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ—Å–ª—è –º—ñ–≥—Ä–∞—Ü—ñ—ó** - –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å–µ –º—ñ–≥—Ä–æ–≤–∞–Ω–æ

---

## üéØ –ü—ñ–¥—Å—É–º–æ–∫

‚úÖ **–í–°–Ü –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**  
‚úÖ **–ù—ñ—á–æ–≥–æ –Ω–µ –≤—Ç—Ä–∞—á–∞—î—Ç—å—Å—è**  
‚úÖ **–ë–µ–∫–∞–ø - –≤–∞—à–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞**  
‚úÖ **–ú–æ–∂–Ω–∞ –≤—ñ–¥–∫–∞—Ç–∏—Ç–∏ –≤ –±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç**

---

**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 2025-11-06


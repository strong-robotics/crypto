# üî¥ –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò: –ê–Ω–∞–ª—ñ–∑ –ë–µ–∑ –í–∏–ø—Ä–∞–≤–ª–µ–Ω—å

## üìã –ü—Ä–æ–±–ª–µ–º–∞ #1: Race Conditions (–°–µ–º–∞—Ñ–æ—Ä–∏)

### üîç –ü–æ—Ç–æ—á–Ω–∞ –°–∏—Ç—É–∞—Ü—ñ—è:

#### ‚úÖ –©–æ –ü—Ä–∞—Ü—é—î:
- **`buy_real()` –º–∞—î atomic locking:**
  ```python
  # –†—è–¥–æ–∫ 1599-1607 –≤ _v2_buy_sell.py
  token_row = await conn.fetchrow(
      "SELECT token_address, decimals, wallet_id FROM tokens WHERE id=$1 FOR UPDATE",
      token_id
  )
  ```
  - `SELECT ... FOR UPDATE` –±–ª–æ–∫—É—î —Ä—è–¥–æ–∫ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
  - Atomic reservation —á–µ—Ä–µ–∑ `UPDATE ... WHERE wallet_id IS NULL RETURNING id` (—Ä—è–¥–æ–∫ 1661-1669)
  - –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–¥–≤—ñ–π–Ω—ñ–π –ø–æ–∫—É–ø—Ü—ñ –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

#### ‚ùå –©–æ –ù–ï –ü—Ä–∞—Ü—é—î:
- **`save_token_data()` –ù–ï –º–∞—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ race conditions:**
  - –ù–µ–º–∞—î `SELECT ... FOR UPDATE` –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
  - –ù–µ–º–∞—î —Å–µ–º–∞—Ñ–æ—Ä—ñ–≤ –∞–±–æ —ñ–Ω—à–∏—Ö –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
  - –ú–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ `buy_real()` –∞–±–æ `force_buy()`

### üêõ –°—Ü–µ–Ω–∞—Ä—ñ–π Race Condition:

**–ß–∞—Å–æ–≤–∞ –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:**

```
T0: save_token_data() –ø–æ—á–∏–Ω–∞—î –æ–±—Ä–æ–±–∫—É token_id=123
T1: save_token_data() –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é:
    SELECT id FROM wallet_history WHERE token_id=123 AND exit_iteration IS NULL
    ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç: NULL (–Ω–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ—ó)
    
T2: [–ü–ê–†–ê–õ–ï–õ–¨–ù–û] force_buy() –ø–æ—á–∏–Ω–∞—î –æ–±—Ä–æ–±–∫—É token_id=123
T3: force_buy() –≤–∏–∫–æ–Ω—É—î SELECT ... FOR UPDATE (–±–ª–æ–∫—É—î —Ä—è–¥–æ–∫)
T4: force_buy() —Å—Ç–≤–æ—Ä—é—î –ø–æ–∑–∏—Ü—ñ—é –≤ wallet_history
T5: force_buy() –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î wallet_id –≤ tokens
T6: force_buy() –∑–∞–≤–µ—Ä—à—É—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (–∑–Ω—ñ–º–∞—î –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)
    
T7: save_token_data() –ø—Ä–æ–¥–æ–≤–∂—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–Ω–µ –∑–Ω–∞—î –ø—Ä–æ –ø–æ–∑–∏—Ü—ñ—é)
T8: save_token_data() –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î history_ready = TRUE
T9: save_token_data() –≤–∏–∫–ª–∏–∫–∞—î archive_token() (—è–∫—â–æ –Ω–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ—ó)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–æ–∫–µ–Ω –º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é (—Å—Ç–≤–æ—Ä–µ–Ω—É –≤ T4)
- –ê–ª–µ `history_ready = TRUE` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–≤ T8)
- –ú–æ–∂–ª–∏–≤–æ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ (–≤ T9) ‚Üí **–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê!**

### üîß –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –†—ñ—à–µ–Ω–Ω—è:

#### –í–∞—Ä—ñ–∞–Ω—Ç 1: –°–µ–º–∞—Ñ–æ—Ä–∏ (Per-Token)
```python
# –í JupiterAnalyzerV3.__init__()
self._token_locks: Dict[int, asyncio.Lock] = {}

async def save_token_data(self, token_id: int, data: Dict[str, Any]) -> bool:
    # –û—Ç—Ä–∏–º–∞—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ lock –¥–ª—è —Ü—å–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    if token_id not in self._token_locks:
        self._token_locks[token_id] = asyncio.Lock()
    
    async with self._token_locks[token_id]:
        # –í—Å—è –ª–æ–≥—ñ–∫–∞ save_token_data()
        ...
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- –ì–∞—Ä–∞–Ω—Ç—É—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- –ù–µ –±–ª–æ–∫—É—î —Ä—ñ–∑–Ω—ñ —Ç–æ–∫–µ–Ω–∏

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ—á–∏—â–∞—Ç–∏ locks (memory leak —Ä–∏–∑–∏–∫)
- –ù–µ –ø—Ä–∞—Ü—é—î –º—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ (—è–∫—â–æ –∫—ñ–ª—å–∫–∞ worker'—ñ–≤)
- –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ `buy_real()` (—Ä—ñ–∑–Ω—ñ –º–æ–¥—É–ª—ñ)

#### –í–∞—Ä—ñ–∞–Ω—Ç 2: Database-Level Locking (SELECT ... FOR UPDATE)
```python
async def save_token_data(self, token_id: int, data: Dict[str, Any]) -> bool:
    pool = await get_db_pool()
    async with pool.acquire() as conn:
        # –ë–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω –Ω–∞ –ø–æ—á–∞—Ç–∫—É
        token_row = await conn.fetchrow(
            "SELECT id, history_ready FROM tokens WHERE id=$1 FOR UPDATE",
            token_id
        )
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é (–ø—ñ—Å–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)
        open_pos = await conn.fetchrow(
            "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL",
            token_id
        )
        
        # –í—Å—è –ª–æ–≥—ñ–∫–∞ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏...
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü—Ä–∞—Ü—é—î –º—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ (database-level locking)
- –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ `buy_real()` (–æ–±–∏–¥–≤–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `FOR UPDATE`)
- –ì–∞—Ä–∞–Ω—Ç—É—î atomic –æ–ø–µ—Ä–∞—Ü—ñ—ó

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –ú–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞ –¥–æ–≤–≥–∏–π —á–∞—Å (—è–∫—â–æ `save_token_data()` –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –¥–æ–≤–≥–æ)
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–±–µ—Ä–µ–∂–Ω–æ –∑ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

#### –í–∞—Ä—ñ–∞–Ω—Ç 3: Optimistic Locking (Version/Timestamp)
```python
# –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ version –≤ tokens
ALTER TABLE tokens ADD COLUMN version INTEGER DEFAULT 0;

# –í save_token_data():
token_row = await conn.fetchrow(
    "SELECT id, version FROM tokens WHERE id=$1",
    token_id
)
current_version = token_row['version']

# –í –∫—ñ–Ω—Ü—ñ save_token_data():
updated = await conn.execute(
    "UPDATE tokens SET version=version+1 WHERE id=$1 AND version=$2",
    token_id, current_version
)
if updated == 0:
    # –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –≤–µ—Ä—Å—ñ–π - —Ö—Ç–æ—Å—å —ñ–Ω—à–∏–π –æ–Ω–æ–≤–∏–≤ —Ç–æ–∫–µ–Ω
    # –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∞–±–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ù–µ –±–ª–æ–∫—É—î –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –ü—Ä–∞—Ü—é—î –≤ high-concurrency —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –°–∫–ª–∞–¥–Ω—ñ—à–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –≤–µ—Ä—Å—ñ–π
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—Ä–æ–ø—É—Å–∫—É –æ–Ω–æ–≤–ª–µ–Ω—å

#### –í–∞—Ä—ñ–∞–Ω—Ç 4: –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è (–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
```python
# Database-level lock –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Å–µ–∫—Ü—ñ–π
# + –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

async def save_token_data(self, token_id: int, data: Dict[str, Any]) -> bool:
    pool = await get_db_pool()
    async with pool.acquire() as conn:
        # –ë–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        async with conn.transaction():
            # –ö—Ä–∏—Ç–∏—á–Ω–∞ —Å–µ–∫—Ü—ñ—è: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–∑–∏—Ü—ñ—ó + –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è
            token_row = await conn.fetchrow(
                "SELECT id, history_ready FROM tokens WHERE id=$1 FOR UPDATE",
                token_id
            )
            
            open_pos = await conn.fetchrow(
                "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL",
                token_id
            )
            
            # –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è - –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç—É—Ç
            if not open_pos and should_archive:
                await archive_token(token_id, conn=conn)
        
        # –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫) - –±–µ–∑ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
        await conn.execute("UPDATE tokens SET ... WHERE id=$1", token_id)
```

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞ #2: History Ready = TRUE –ó –í—ñ–¥–∫—Ä–∏—Ç–æ—é –ü–æ–∑–∏—Ü—ñ—î—é

### üîç –ü–æ—Ç–æ—á–Ω–∞ –°–∏—Ç—É–∞—Ü—ñ—è:

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ñ –ú—ñ—Å—Ü—è:

**1. Bad Pattern Guard (—Ä—è–¥–∫–∏ 1225-1237):**
```python
else:
    # Open position exists - DO NOT archive, just mark as history_ready
    await conn.execute(
        """
        UPDATE tokens
        SET history_ready = TRUE,  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
            token_updated_at = CURRENT_TIMESTAMP
        WHERE id=$1
        """,
        token_id
    )
```

**2. Bad Decision (NOT) Guard (—Ä—è–¥–∫–∏ 1306-1318):**
```python
else:
    # Open position exists - DO NOT archive, just mark as history_ready
    await conn.execute(
        """
        UPDATE tokens
        SET history_ready = TRUE,  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
            token_updated_at = CURRENT_TIMESTAMP
        WHERE id=$1
        """,
        token_id
    )
```

**3. Corridor Drop (—Ä—è–¥–∫–∏ 1441-1476):**
```python
async def _flag_corridor_drop(...):
    open_pos_check = await conn.fetchrow(...)
    
    await conn.execute(
        "UPDATE tokens SET history_ready = TRUE, ... WHERE id=$1"
    )  # ‚ùå –í—Å—Ç–∞–Ω–æ–≤–ª—é—î history_ready –î–û –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–æ–∑–∏—Ü—ñ—ó!
    
    if not open_pos_check:
        await archive_token(...)
    # else: history_ready –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∞–ª–µ –ø–æ–∑–∏—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç–∞!
```

### üêõ –ù–∞—Å–ª—ñ–¥–∫–∏:

**1. –¢–æ–∫–µ–Ω –í–∏–ø–∞–¥–∞—î –ó –û–±—Ä–æ–±–∫–∏:**
```python
# get_tokens_batch() —Ñ—ñ–ª—å—Ç—Ä—É—î —Ç—ñ–ª—å–∫–∏ history_ready = FALSE
SELECT id, token_address
FROM tokens
WHERE history_ready = FALSE  # ‚ùå –¢–æ–∫–µ–Ω –∑ –ø–æ–∑–∏—Ü—ñ—î—é –Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è!
```

**2. –¢–æ–∫–µ–Ω –ù–µ –í –ê—Ä—Ö—ñ–≤—ñ:**
```python
# archive_token() –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, —è–∫—â–æ —î –ø–æ–∑–∏—Ü—ñ—è
# –¢–æ–∫–µ–Ω –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—ñ tokens –∑ history_ready = TRUE
# –ê–ª–µ –Ω–µ –≤ tokens_history
```

**3. "–ó–∞–≤–∏—Å–ª—ñ" –¢–æ–∫–µ–Ω–∏:**
- –¢–æ–∫–µ–Ω –º–∞—î `history_ready = TRUE`
- –¢–æ–∫–µ–Ω –º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –≤ `wallet_history`
- –¢–æ–∫–µ–Ω –ù–ï –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –≤ `get_tokens_batch()`
- –¢–æ–∫–µ–Ω –ù–ï –≤ –∞—Ä—Ö—ñ–≤—ñ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–∫–µ–Ω "–∑–∞–≤–∏—Å–∞—î" –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏

### üîß –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –õ–æ–≥—ñ–∫–∞:

**`history_ready = TRUE` –æ–∑–Ω–∞—á–∞—î:**
- –¢–æ–∫–µ–Ω –≥–æ—Ç–æ–≤–∏–π –¥–æ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó
- –¢–æ–∫–µ–Ω –ù–ï –º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–æ–∑–∏—Ü—ñ–π
- –¢–æ–∫–µ–Ω –±—É–¥–µ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π (–ø–µ—Ä–µ–º—ñ—â–µ–Ω–∏–π –≤ `tokens_history`)

**–Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è:**
- `history_ready` –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–ª–∏—à–∞—Ç–∏—Å—è `FALSE`
- –¢–æ–∫–µ–Ω –ø—Ä–æ–¥–æ–≤–∂—É—î –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è –≤ `get_tokens_batch()`
- –¢–æ–∫–µ–Ω –ù–ï –º–æ–∂–µ –±—É—Ç–∏ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó

### üîß –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –†—ñ—à–µ–Ω–Ω—è:

#### –í–∞—Ä—ñ–∞–Ω—Ç 1: –ù–ï –í—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ `history_ready = TRUE` –Ø–∫—â–æ –Ñ –ü–æ–∑–∏—Ü—ñ—è
```python
if not open_pos_check:
    # –ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ—ó - –º–æ–∂–Ω–∞ –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    await conn.execute("UPDATE tokens SET history_ready = TRUE WHERE id=$1")
    await archive_token(token_id, conn=conn)
else:
    # –Ñ –ø–æ–∑–∏—Ü—ñ—è - –ù–ï –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ history_ready
    # –¢–æ–∫–µ–Ω –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ –æ–±—Ä–æ–±—Ü—ñ
    if self.debug:
        print(f"Token {token_id} has open position - NOT marking as history_ready")
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –¢–æ–∫–µ–Ω –ø—Ä–æ–¥–æ–≤–∂—É—î –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è
- –õ–æ–≥—ñ–∫–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∞

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –¢–æ–∫–µ–Ω –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–Ω "–ø–æ–≥–∞–Ω–∏–π"
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –∑–∞–π–≤–∏—Ö API –∑–∞–ø–∏—Ç—ñ–≤

#### –í–∞—Ä—ñ–∞–Ω—Ç 2: –î–æ–¥–∞—Ç–∏ –§–ª–∞–≥ `skip_analysis` –ó–∞–º—ñ—Å—Ç—å `history_ready`
```python
# –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ skip_analysis –≤ tokens
ALTER TABLE tokens ADD COLUMN skip_analysis BOOLEAN DEFAULT FALSE;

# –í get_tokens_batch():
SELECT id, token_address
FROM tokens
WHERE history_ready = FALSE AND skip_analysis = FALSE

# –í guard'–∞—Ö:
if not open_pos_check:
    await conn.execute("UPDATE tokens SET history_ready = TRUE WHERE id=$1")
    await archive_token(token_id, conn=conn)
else:
    # –Ñ –ø–æ–∑–∏—Ü—ñ—è - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑, –∞–ª–µ –Ω–µ –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    await conn.execute("UPDATE tokens SET skip_analysis = TRUE WHERE id=$1")
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –†–æ–∑–¥—ñ–ª—è—î "–≥–æ—Ç–æ–≤–∏–π –¥–æ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó" —Ç–∞ "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑"
- –¢–æ–∫–µ–Ω –Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è, –∞–ª–µ —ñ –Ω–µ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π
- –ü–æ–∑–∏—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–∫—Ä–∏—Ç–∞ –ø—ñ–∑–Ω—ñ—à–µ

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –ø–æ–ª–µ
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –º—ñ—Å—Ü—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

#### –í–∞—Ä—ñ–∞–Ω—Ç 3: –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ü–æ–∑–∏—Ü—ñ—é –í `get_tokens_batch()`
```python
async def get_tokens_batch(self) -> List[Dict[str, Any]]:
    # –í–∫–ª—é—á–∏—Ç–∏ —Ç–æ–∫–µ–Ω–∏ –∑ history_ready = TRUE, —è–∫—â–æ –≤–æ–Ω–∏ –º–∞—é—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é
    rows = await conn.fetch(
        """
        SELECT t.id, t.token_address
        FROM tokens t
        WHERE t.history_ready = FALSE
           OR (t.history_ready = TRUE AND EXISTS (
               SELECT 1 FROM wallet_history 
               WHERE token_id = t.id AND exit_iteration IS NULL
           ))
        ORDER BY t.token_updated_at ASC NULLS FIRST, t.id ASC
        """
    )
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É guard'—ñ–≤
- –¢–æ–∫–µ–Ω–∏ –∑ –ø–æ–∑–∏—Ü—ñ—è–º–∏ –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –°–∫–ª–∞–¥–Ω—ñ—à–∏–π SQL –∑–∞–ø–∏—Ç
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –æ–±—Ä–æ–±–∫–∏ "–ø–æ–≥–∞–Ω–∏—Ö" —Ç–æ–∫–µ–Ω—ñ–≤
- –ù–µ –≤–∏—Ä—ñ—à—É—î –ø—Ä–æ–±–ª–µ–º—É "–∑–∞–≤–∏—Å–ª–∏—Ö" —Ç–æ–∫–µ–Ω—ñ–≤

#### –í–∞—Ä—ñ–∞–Ω—Ç 4: –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è (–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
```python
# 1. –ù–ï –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ history_ready = TRUE —è–∫—â–æ —î –ø–æ–∑–∏—Ü—ñ—è
if not open_pos_check:
    await conn.execute("UPDATE tokens SET history_ready = TRUE WHERE id=$1")
    await archive_token(token_id, conn=conn)
else:
    # –Ñ –ø–æ–∑–∏—Ü—ñ—è - –∑–∞–ª–∏—à–∏—Ç–∏ history_ready = FALSE
    # –¢–æ–∫–µ–Ω –ø—Ä–æ–¥–æ–≤–∂–∏—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è
    # –ö–æ–ª–∏ –ø–æ–∑–∏—Ü—ñ—è –∑–∞–∫—Ä–∏—î—Ç—å—Å—è - —Ç–æ–¥—ñ –º–æ–∂–Ω–∞ –±—É–¥–µ –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    pass

# 2. –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –≤ get_tokens_batch() –¥–ª—è –±–µ–∑–ø–µ–∫–∏
# (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —è–∫—â–æ –¥–µ—Å—å –≤—Å–µ –∂ —Ç–∞–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ history_ready = TRUE)
```

---

## üìä –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ –¢–∞–±–ª–∏—Ü—è –†—ñ—à–µ–Ω—å:

| –†—ñ—à–µ–Ω–Ω—è | –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å | –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å | –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è |
|---------|------------|--------------|---------------|--------------|
| **Race Conditions:** | | | | |
| –°–µ–º–∞—Ñ–æ—Ä–∏ (Per-Token) | –ù–∏–∑—å–∫–∞ | –°–µ—Ä–µ–¥–Ω—è | ‚ùå –ú—ñ–∂ –º–æ–¥—É–ª—è–º–∏ | ‚ö†Ô∏è –ù–µ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ |
| Database Locking | –°–µ—Ä–µ–¥–Ω—è | –í–∏—Å–æ–∫–∞ | ‚úÖ –ú—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ |
| Optimistic Locking | –í–∏—Å–æ–∫–∞ | –í–∏—Å–æ–∫–∞ | ‚úÖ –ú—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ | ‚ö†Ô∏è –°–∫–ª–∞–¥–Ω—ñ—à–µ |
| –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è | –í–∏—Å–æ–∫–∞ | –í–∏—Å–æ–∫–∞ | ‚úÖ –ú—ñ–∂ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ | ‚úÖ –ù–∞–π–∫—Ä–∞—â–µ |
| **History Ready:** | | | | |
| –ù–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ | –ù–∏–∑—å–∫–∞ | –í–∏—Å–æ–∫–∞ | ‚úÖ –ü—Ä–æ—Å—Ç–æ | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ |
| –§–ª–∞–≥ skip_analysis | –°–µ—Ä–µ–¥–Ω—è | –í–∏—Å–æ–∫–∞ | ‚úÖ –ì–Ω—É—á–∫–æ | ‚ö†Ô∏è –î–æ–¥–∞—Ç–∫–æ–≤–µ –ø–æ–ª–µ |
| –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ batch | –ù–∏–∑—å–∫–∞ | –°–µ—Ä–µ–¥–Ω—è | ‚ö†Ô∏è Workaround | ‚ùå –ù–µ –≤–∏—Ä—ñ—à—É—î |
| –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è | –°–µ—Ä–µ–¥–Ω—è | –í–∏—Å–æ–∫–∞ | ‚úÖ –ù–∞–¥—ñ–π–Ω–æ | ‚úÖ –ù–∞–π–∫—Ä–∞—â–µ |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:

### –î–ª—è Race Conditions:
1. **–î–æ–¥–∞—Ç–∏ `SELECT ... FOR UPDATE` –≤ `save_token_data()`** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–∑–∏—Ü—ñ—ó + –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è)
2. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó** –¥–ª—è atomic –æ–ø–µ—Ä–∞—Ü—ñ–π
3. **–ú—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ —á–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è** - –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Å–µ–∫—Ü—ñ–π

### –î–ª—è History Ready:
1. **–ù–ï –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ `history_ready = TRUE` —è–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è**
2. **–ó–∞–ª–∏—à–∏—Ç–∏ `history_ready = FALSE`** –¥–ª—è —Ç–æ–∫–µ–Ω—ñ–≤ –∑ –ø–æ–∑–∏—Ü—ñ—è–º–∏
3. **–î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –≤ `get_tokens_batch()`** –¥–ª—è –±–µ–∑–ø–µ–∫–∏ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –ø–æ–º–∏–ª–æ–∫)
4. **–í—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ `history_ready = TRUE` —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó** (–≤ `finalize_token_sale()`)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–Ü –ú–û–ú–ï–ù–¢–ò:

1. **Race Condition –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ:**
   - –ê—Ä—Ö—ñ–≤–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω–∞ –∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –ø–æ–∑–∏—Ü—ñ—î—é
   - –í—Ç—Ä–∞—Ç–∏ –≥—Ä–æ—à–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
   - –ù–µ–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø—Ä–æ–¥–∞—Ç–∏ —Ç–æ–∫–µ–Ω

2. **History Ready = TRUE –∑ –ø–æ–∑–∏—Ü—ñ—î—é –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ:**
   - –¢–æ–∫–µ–Ω –Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è (–Ω–µ –æ—Ç—Ä–∏–º—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è)
   - –¢–æ–∫–µ–Ω –Ω–µ –≤ –∞—Ä—Ö—ñ–≤—ñ (–∑–∞–≤–∏—Å–∞—î –≤ —Å—Ç–∞–Ω—ñ)
   - –ù–µ–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ —Ç–æ–∫–µ–Ω

3. **–û–±–∏–¥–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∫—Ä–∏—Ç–∏—á–Ω—ñ** —ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –Ω–µ–≥–∞–π–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è.


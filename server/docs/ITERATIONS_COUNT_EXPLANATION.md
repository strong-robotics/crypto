# –ü–æ—è—Å–Ω–µ–Ω–Ω—è: –ß–æ–º—É `get_token_iterations_count` —î –¥—É–±–ª—ñ–∫–∞—Ç–æ–º

## üéØ –©–æ —Ç–∞–∫–µ "—ñ—Ç–µ—Ä–∞—Ü—ñ—è" –≤ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ?

**–Ü—Ç–µ—Ä–∞—Ü—ñ—è** = –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–∫—É–Ω–¥ –∂–∏—Ç—Ç—è —Ç–æ–∫–µ–Ω–∞ –∑ –≤–∞–ª—ñ–¥–Ω–æ—é —Ü—ñ–Ω–æ—é (usd_price > 0).

### –ü—Ä–∏–∫–ª–∞–¥:
- –°–µ–∫—É–Ω–¥–∞ 0: —Ç–æ–∫–µ–Ω —Å—Ç–≤–æ—Ä–µ–Ω–æ, —Ü—ñ–Ω–∞ = $0.001 ‚Üí **—ñ—Ç–µ—Ä–∞—Ü—ñ—è 1**
- –°–µ–∫—É–Ω–¥–∞ 1: —Ü—ñ–Ω–∞ = $0.002 ‚Üí **—ñ—Ç–µ—Ä–∞—Ü—ñ—è 2**
- –°–µ–∫—É–Ω–¥–∞ 2: —Ü—ñ–Ω–∞ = NULL (–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö) ‚Üí **–Ω–µ —Ä–∞—Ö—É—î—Ç—å—Å—è**
- –°–µ–∫—É–Ω–¥–∞ 3: —Ü—ñ–Ω–∞ = $0.003 ‚Üí **—ñ—Ç–µ—Ä–∞—Ü—ñ—è 3**
- –°–µ–∫—É–Ω–¥–∞ 4: —Ü—ñ–Ω–∞ = $0.000 (rug pull) ‚Üí **–Ω–µ —Ä–∞—Ö—É—î—Ç—å—Å—è** (usd_price = 0)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∞ 5-–π —Å–µ–∫—É–Ω–¥—ñ –∂–∏—Ç—Ç—è —Ç–æ–∫–µ–Ω–∞ –º–∞—î–º–æ **3 —ñ—Ç–µ—Ä–∞—Ü—ñ—ó** (—Ç—ñ–ª—å–∫–∏ —Å–µ–∫—É–Ω–¥–∏ –∑ –≤–∞–ª—ñ–¥–Ω–æ—é —Ü—ñ–Ω–æ—é).

---

## üîç –ß–æ–º—É —Ü–µ –¥—É–±–ª—ñ–∫–∞—Ç?

### –û–¥–Ω–∞–∫–æ–≤–∏–π SQL –∑–∞–ø–∏—Ç –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö:

```sql
SELECT COUNT(*) 
FROM token_metrics_seconds 
WHERE token_id=$1 
  AND usd_price IS NOT NULL 
  AND usd_price > 0
```

**–¶–µ–π –∑–∞–ø–∏—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤:**

1. **`_v3_analyzer_jupiter.py`** (4+ –º—ñ—Å—Ü—è):
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ `PRICE_CORRIDOR_FINAL_END` (170s)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ `AUTO_BUY_ENTRY_SEC` (171s)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ `BAD_PATTERN_HISTORY_READY_ITERS` (100s)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ `ETA_MAX_TOKEN_AGE_SEC` (480s)

2. **`_v2_buy_sell.py`** (3 –º—ñ—Å—Ü—è):
   - –ó–∞–ø–∏—Å `entry_iteration` –ø—Ä–∏ –ø–æ–∫—É–ø—Ü—ñ (—Ä—è–¥–æ–∫ 1345)
   - –ó–∞–ø–∏—Å `exit_iteration` –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂—ñ (—Ä—è–¥–æ–∫ 996)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–∫—É —Ç–æ–∫–µ–Ω–∞

---

## üí° –Ø–∫ –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–∞—Ü—é—î –≤ —Ä—ñ–∑–Ω–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö?

### –ü—Ä–∏–∫–ª–∞–¥ 1: Analyzer (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–∫—É —Ç–æ–∫–µ–Ω–∞)

```python
# _v3_analyzer_jupiter.py (—Ä—è–¥–æ–∫ 390)
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ 170 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ MIN_TX_COUNT?

iterations_count = int(
    await conn.fetchval(
        """
        SELECT COUNT(*)
        FROM token_metrics_seconds
        WHERE token_id=$1 AND usd_price IS NOT NULL AND usd_price > 0
        """,
        token_id,
    )
    or 0
)

if iterations_count >= 170:  # PRICE_CORRIDOR_FINAL_END
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ MIN_TX_COUNT —Ç–∞ MIN_SELL_SHARE
    # ...
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Analyzer –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —Ç–æ–∫–µ–Ω "–¥–æ—Ä—ñ—Å" –¥–æ –ø–µ–≤–Ω–æ–≥–æ –≤—ñ–∫—É, —â–æ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.

---

### –ü—Ä–∏–∫–ª–∞–¥ 2: Buy/Sell (–∑–∞–ø–∏—Å —ñ—Ç–µ—Ä–∞—Ü—ñ—ó –≤ —ñ—Å—Ç–æ—Ä—ñ—é)

```python
# _v2_buy_sell.py (—Ä—è–¥–æ–∫ 1338)
# –ó–∞–ø–∏—Å: –Ω–∞ —è–∫—ñ–π —ñ—Ç–µ—Ä–∞—Ü—ñ—ó (—Å–µ–∫—É–Ω–¥—ñ) –º–∏ –∫—É–ø–∏–ª–∏ —Ç–æ–∫–µ–Ω?

current_iteration = await conn.fetchval(
    """
    SELECT COUNT(*) FROM token_metrics_seconds
    WHERE token_id=$1 AND usd_price IS NOT NULL AND usd_price > 0
    """,
    token_id
)
entry_iteration = int(current_iteration or 0)

# –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ wallet_history
await conn.execute(
    """
    INSERT INTO wallet_history (..., entry_iteration, ...)
    VALUES (..., $1, ...)
    """,
    entry_iteration
)
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Buy/Sell –∑–∞–ø–∏—Å—É—î, –Ω–∞ —è–∫—ñ–π —Å–µ–∫—É–Ω–¥—ñ –∂–∏—Ç—Ç—è —Ç–æ–∫–µ–Ω–∞ –≤—ñ–¥–±—É–ª–∞—Å—è –ø–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–∞–∂.

---

### –ü—Ä–∏–∫–ª–∞–¥ 3: Analyzer (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è auto-buy)

```python
# _v3_analyzer_jupiter.py (—Ä—è–¥–æ–∫ 1062)
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ 171 —Å–µ–∫—É–Ω–¥ –¥–ª—è auto-buy?

auto_buy_check = await conn.fetchrow(
    """
    WITH mc AS (
      SELECT COUNT(*) AS cnt
      FROM token_metrics_seconds
      WHERE token_id=$1 AND usd_price IS NOT NULL AND usd_price > 0
    ), ...
    SELECT mc.cnt AS iterations, ...
    FROM mc, ...
    WHERE mc.cnt >= 171  -- AUTO_BUY_ENTRY_SEC
    """,
    token_id
)
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Analyzer –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —Ç–æ–∫–µ–Ω "–¥–æ—Ä—ñ—Å" –¥–æ 171 —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –ø–æ–∫—É–ø–∫–∏.

---

## ‚úÖ –ß–æ–º—É —Ü–µ –¥—É–±–ª—ñ–∫–∞—Ç?

### 1. **–û–¥–Ω–∞–∫–æ–≤–∏–π SQL –∑–∞–ø–∏—Ç**
–í—Å—ñ –º—ñ—Å—Ü—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å **—ñ–¥–µ–Ω—Ç–∏—á–Ω–∏–π** SQL –∑–∞–ø–∏—Ç:
```sql
SELECT COUNT(*) 
FROM token_metrics_seconds 
WHERE token_id=$1 
  AND usd_price IS NOT NULL 
  AND usd_price > 0
```

### 2. **–û–¥–Ω–∞–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞**
–í—Å—ñ –º—ñ—Å—Ü—è —Ä–∞—Ö—É—é—Ç—å **–æ–¥–Ω–µ —ñ —Ç–µ —Å–∞–º–µ**: –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–∫—É–Ω–¥ –∑ –≤–∞–ª—ñ–¥–Ω–æ—é —Ü—ñ–Ω–æ—é.

### 3. **–û–¥–Ω–∞–∫–æ–≤–∞ –º–µ—Ç–∞**
–í—Å—ñ –º—ñ—Å—Ü—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è **–æ–¥–Ω—ñ—î—ó –º–µ—Ç–∏**: –≤–∏–∑–Ω–∞—á–∏—Ç–∏ "–≤—ñ–∫" —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.

### 4. **–û–¥–Ω–∞–∫–æ–≤–µ –æ–±—Ä–æ–±–ª–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤**
–í—Å—ñ –º—ñ—Å—Ü—è —Ä–æ–±–ª—è—Ç—å **–æ–¥–Ω–µ —ñ —Ç–µ —Å–∞–º–µ**:
```python
int(await conn.fetchval(...) or 0)
```

---

## üîÑ –Ø–∫ –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–∞—Ü—é—î –≤ —Ä—ñ–∑–Ω–∏—Ö –º–æ–¥—É–ª—è—Ö?

### –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ—Å—Ç—å —Ñ—É–Ω–∫—Ü—ñ—ó:

```python
async def get_token_iterations_count(conn, token_id: int) -> int:
    """Get count of iterations (records with valid price) for token"""
    return int(
        await conn.fetchval(
            "SELECT COUNT(*) FROM token_metrics_seconds WHERE token_id=$1 AND usd_price IS NOT NULL AND usd_price > 0",
            token_id
        ) or 0
    )
```

**–¶—è —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–∞—Ü—é—î –≤ –±—É–¥—å-—è–∫–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ, —Ç–æ–º—É —â–æ:**

1. **–ù–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É** - –≤–æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Ö—É—î —Å–µ–∫—É–Ω–¥–∏
2. **–ü–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–æ—Å—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è** - —á–∏—Å–ª–æ (int)
3. **–ù–µ –º–∞—î –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤** - –Ω–µ –∑–º—ñ–Ω—é—î —Å—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏
4. **–ß–∏—Å—Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—è** - –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤—Ö–æ–¥—É –∑–∞–≤–∂–¥–∏ –æ–¥–∏–Ω –≤–∏—Ö—ñ–¥

---

## üìä –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —Ä—ñ–∑–Ω–∏—Ö –º–æ–¥—É–ª—è—Ö:

### Analyzer: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–∫—É –¥–ª—è –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó

```python
# _v3_analyzer_jupiter.py
from _v3_db_utils import get_token_iterations_count

iterations = await get_token_iterations_count(conn, token_id)

if iterations >= 480:  # ETA_MAX_TOKEN_AGE_SEC
    # –¢–æ–∫–µ–Ω –∑–∞–Ω–∞–¥—Ç–æ —Å—Ç–∞—Ä–∏–π - –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    await finalize_token_sale(token_id, conn, reason='max_age_timeout')
```

### Analyzer: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–∫—É –¥–ª—è auto-buy

```python
# _v3_analyzer_jupiter.py
from _v3_db_utils import get_token_iterations_count

iterations = await get_token_iterations_count(conn, token_id)

if iterations >= 171:  # AUTO_BUY_ENTRY_SEC
    # –¢–æ–∫–µ–Ω "–¥–æ—Ä—ñ—Å" –¥–æ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥—É - –º–æ–∂–Ω–∞ –∫—É–ø—É–≤–∞—Ç–∏
    if decision == "buy" and segments_allow_entry:
        await buy_real(token_id)
```

### Buy/Sell: –ó–∞–ø–∏—Å entry_iteration

```python
# _v2_buy_sell.py
from _v3_db_utils import get_token_iterations_count

# –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –ø–æ–∫—É–ø–∫–∏
entry_iteration = await get_token_iterations_count(conn, token_id)

await conn.execute(
    """
    INSERT INTO wallet_history (..., entry_iteration, ...)
    VALUES (..., $1, ...)
    """,
    entry_iteration
)
```

### Buy/Sell: –ó–∞–ø–∏—Å exit_iteration

```python
# _v2_buy_sell.py
from _v3_db_utils import get_token_iterations_count

# –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –ø—Ä–æ–¥–∞–∂—ñ
exit_iteration = await get_token_iterations_count(conn, token_id)

await conn.execute(
    """
    UPDATE wallet_history 
    SET exit_iteration = $1, ...
    WHERE token_id = $2
    """,
    exit_iteration, token_id
)
```

---

## üéØ –í–∏—Å–Ω–æ–≤–æ–∫

### –ß–æ–º—É —Ü–µ –¥—É–±–ª—ñ–∫–∞—Ç?
- ‚úÖ –û–¥–Ω–∞–∫–æ–≤–∏–π SQL –∑–∞–ø–∏—Ç
- ‚úÖ –û–¥–Ω–∞–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ (–ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Å–µ–∫—É–Ω–¥)
- ‚úÖ –û–¥–Ω–∞–∫–æ–≤–∞ –º–µ—Ç–∞ (–≤–∏–∑–Ω–∞—á–∏—Ç–∏ –≤—ñ–∫ —Ç–æ–∫–µ–Ω–∞)
- ‚úÖ –û–¥–Ω–∞–∫–æ–≤–µ –æ–±—Ä–æ–±–ª–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

### –ß–æ–º—É –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–∞—Ü—é—î –≤ —Ä—ñ–∑–Ω–∏—Ö –º–æ–¥—É–ª—è—Ö?
- ‚úÖ –§—É–Ω–∫—Ü—ñ—è **–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É** - –≤–æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Ö—É—î
- ‚úÖ –§—É–Ω–∫—Ü—ñ—è **–ø–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–æ—Å—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è** - —á–∏—Å–ª–æ
- ‚úÖ –§—É–Ω–∫—Ü—ñ—è **–Ω–µ –º–∞—î –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤** - –Ω–µ –∑–º—ñ–Ω—é—î —Å—Ç–∞–Ω
- ‚úÖ –§—É–Ω–∫—Ü—ñ—è **—á–∏—Å—Ç–∞** - –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤—Ö–æ–¥—É –∑–∞–≤–∂–¥–∏ –æ–¥–∏–Ω –≤–∏—Ö—ñ–¥

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?
1. **Analyzer** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–∫—É —Ç–æ–∫–µ–Ω–∞ (—á–∏ –¥–æ—Å—è–≥ 170s? 171s? 480s?)
2. **Buy/Sell** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–ª—è –∑–∞–ø–∏—Å—É —ñ—Ç–µ—Ä–∞—Ü—ñ—ó –≤ —ñ—Å—Ç–æ—Ä—ñ—é (–Ω–∞ —è–∫—ñ–π —Å–µ–∫—É–Ω–¥—ñ –∫—É–ø–∏–ª–∏/–ø—Ä–æ–¥–∞–ª–∏?)
3. **–û–±–∏–¥–≤–∞ –º–æ–¥—É–ª—ñ** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å **–æ–¥–Ω—É —ñ —Ç—É —Å–∞–º—É —Ñ—É–Ω–∫—Ü—ñ—é** - –≤–æ–Ω–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞!

---

## üí° –ê–Ω–∞–ª–æ–≥—ñ—è

–¶–µ —è–∫ —Ñ—É–Ω–∫—Ü—ñ—è `len()` –≤ Python:
- `len("hello")` ‚Üí 5 (–¥–æ–≤–∂–∏–Ω–∞ —Ä—è–¥–∫–∞)
- `len([1,2,3])` ‚Üí 3 (–¥–æ–≤–∂–∏–Ω–∞ —Å–ø–∏—Å–∫—É)
- `len({"a": 1})` ‚Üí 1 (–¥–æ–≤–∂–∏–Ω–∞ —Å–ª–æ–≤–Ω–∏–∫–∞)

**–û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —Ä—ñ–∑–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏, –æ–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞!**

–¢–∞–∫ —Å–∞–º–æ `get_token_iterations_count()`:
- –í analyzer ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–∫—É
- –í buy/sell ‚Üí –∑–∞–ø–∏—Å —ñ—Ç–µ—Ä–∞—Ü—ñ—ó
- –í cleaner ‚Üí –ø–æ—à—É–∫ —Å—Ç–∞—Ä–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤

**–û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —Ä—ñ–∑–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏, –æ–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞!**


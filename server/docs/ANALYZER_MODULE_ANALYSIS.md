# üìã –î–µ—Ç–∞–ª—å–Ω–∏–π –ê–Ω–∞–ª—ñ–∑ –ú–æ–¥—É–ª—è `_v3_analyzer_jupiter.py`

## üéØ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ú–æ–¥—É–ª—è

–ú–æ–¥—É–ª—å `JupiterAnalyzerV3` - —Ü–µ –≥–æ–ª–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä —Ç–æ–∫–µ–Ω—ñ–≤, —è–∫–∏–π:
- –ó–±–∏—Ä–∞—î –¥–∞–Ω—ñ –∑ Jupiter API –ø—Ä–æ —Ç–æ–∫–µ–Ω–∏
- –ê–Ω–∞–ª—ñ–∑—É—î –ø–∞—Ç–µ—Ä–Ω–∏ —Ü—ñ–Ω–∏ —á–µ—Ä–µ–∑ ML –º–æ–¥–µ–ª—å
- –ü—Ä–∏–π–º–∞—î —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É/–∞–≤—Ç–æ–ø—Ä–æ–¥–∞–∂—É
- **–ö–†–ò–¢–ò–ß–ù–û:** –ó–∞—Ö–∏—â–∞—î —Ç–æ–∫–µ–Ω–∏ –∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º–∏ –ø–æ–∑–∏—Ü—ñ—è–º–∏ –≤—ñ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó

---

## üì¶ –ö–ª–∞—Å `JupiterAnalyzerV3`

### `__init__(self)` (—Ä—è–¥–∫–∏ 29-74)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –∑ `config.py`
- –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î ML –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ –ø–∞—Ç–µ—Ä–Ω—ñ–≤
- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –ø–æ—Ä–æ–≥–∏ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –ª—ñ–∫–≤—ñ–¥–Ω–æ—Å—Ç—ñ

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å ML –º–æ–¥–µ–ª—ñ (`pattern_segments.pkl`)
- –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ config

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `ensure_session(self)` (—Ä—è–¥–∫–∏ 76-105)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –°—Ç–≤–æ—Ä—é—î HTTP —Å–µ—Å—ñ—é –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ Jupiter API
- –°—Ç–≤–æ—Ä—é—î —Ç–∞–±–ª–∏—Ü—é `token_metrics_seconds` —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –°—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—Ç–∞–±–ª–∏—Ü—è + —ñ–Ω–¥–µ–∫—Å–∏)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —Å–µ—Å—ñ—ó
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ñ

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_load_segment_model(self)` (—Ä—è–¥–∫–∏ 107-120)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î ML –º–æ–¥–µ–ª—å –∑ —Ñ–∞–π–ª—É `models/pattern_segments.pkl`
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î encoder –¥–ª—è –º—ñ—Ç–æ–∫ —Å–µ–≥–º–µ–Ω—Ç—ñ–≤

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤ –ø–∞–º'—è—Ç—å)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—É –º–æ–¥–µ–ª—ñ
- –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å payload –º–æ–¥–µ–ª—ñ

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_normalize_segment_label(value)` (—Ä—è–¥–∫–∏ 122-129)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ù–æ—Ä–º–∞–ª—ñ–∑—É—î –º—ñ—Ç–∫—É —Å–µ–≥–º–µ–Ω—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "super" ‚Üí "best")
- –ü–æ–≤–µ—Ä—Ç–∞—î "unknown" –¥–ª—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö –∑–Ω–∞—á–µ–Ω—å

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Å—Ç–∞—Ç–∏—á–Ω–∏–π –º–µ—Ç–æ–¥)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å –≤—Ö—ñ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_detect_post_entry_drop(prices, entry_sec, post_entry_end, drop_threshold)` (—Ä—è–¥–∫–∏ 131-173)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –í–∏—è–≤–ª—è—î –∑–Ω–∞—á–Ω–µ –ø–∞–¥—ñ–Ω–Ω—è —Ü—ñ–Ω–∏ –ø—ñ—Å–ª—è —Ç–æ—á–∫–∏ –≤—Ö–æ–¥—É (155-170 —Å–µ–∫—É–Ω–¥)
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø–∞–¥–∞—î —Ü—ñ–Ω–∞ –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ `drop_threshold` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 15%)

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ –∞–Ω–∞–ª—ñ–∑)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—å–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
- –¶—ñ–Ω—É –Ω–∞ —Ç–æ—á—Ü—ñ –≤—Ö–æ–¥—É (155s)
- –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—É —Ü—ñ–Ω—É –≤ –≤—ñ–∫–Ω—ñ 155-170s
- –í—ñ–¥—Å–æ—Ç–æ–∫ –ø–∞–¥—ñ–Ω–Ω—è

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î (—Ç—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î `decision = "not"` –≤ `_update_segment_predictions`)

---

### `_detect_liquidity_withdraw(total_points, recent_rows)` (—Ä—è–¥–∫–∏ 175-217)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –í–∏—è–≤–ª—è—î –≤–∏–≤–µ–¥–µ–Ω–Ω—è –ª—ñ–∫–≤—ñ–¥–Ω–æ—Å—Ç—ñ (flat/zero —Ü—ñ–Ω–∞/mcap)
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î –æ—Å—Ç–∞–Ω–Ω—ñ N –∑–∞–ø–∏—Å—ñ–≤ –Ω–∞ –æ–¥–Ω–∞–∫–æ–≤—ñ –∞–±–æ –Ω—É–ª—å–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ –∞–Ω–∞–ª—ñ–∑)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—å–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫
- –û—Å—Ç–∞–Ω–Ω—ñ N –∑–∞–ø–∏—Å—ñ–≤ –Ω–∞ flat/zero –∑–Ω–∞—á–µ–Ω–Ω—è
- –î—ñ–∞–ø–∞–∑–æ–Ω —Ü—ñ–Ω–∏ —Ç–∞ mcap (—è–∫—â–æ <= epsilon ‚Üí flat)

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î (—Ç—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î `decision = "not"` –≤ `_update_segment_predictions`)

---

### `_segments_allow_entry(labels)` (—Ä—è–¥–∫–∏ 219-254)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∏ –ø–∞—Ç–µ—Ä–Ω—É –≤—Ö—ñ–¥ —É —Ç–æ–∫–µ–Ω
- –ë–ª–æ–∫—É—î –≤—Ö—ñ–¥ —è–∫—â–æ —î "bad", "risk", "flat", "unknown"
- –î–æ–∑–≤–æ–ª—è—î –≤—Ö—ñ–¥ —è–∫—â–æ –≤—Å—ñ —Å–µ–≥–º–µ–Ω—Ç–∏ "best" –∞–±–æ "good"
- –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ "middle" —Å–µ–≥–º–µ–Ω—Ç—É

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –º—ñ—Ç–∫–∏ —Å–µ–≥–º–µ–Ω—Ç—ñ–≤
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å "middle" —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ (–º–∞–∫—Å–∏–º—É–º 1)
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö –º—ñ—Ç–æ–∫

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_update_segment_predictions(conn, token_id)` (—Ä—è–¥–∫–∏ 256-506)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- **–ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –ê–ù–ê–õ–Ü–ó–£:** –ê–Ω–∞–ª—ñ–∑—É—î –ø–∞—Ç–µ—Ä–Ω–∏ —Ü—ñ–Ω–∏ —á–µ—Ä–µ–∑ ML –º–æ–¥–µ–ª—å
- –ß–∏—Ç–∞—î –º–µ—Ç—Ä–∏–∫–∏ –∑ `token_metrics_seconds`
- –ì–µ–Ω–µ—Ä—É—î –ø—Ä–æ–≥–Ω–æ–∑–∏ –¥–ª—è 3 —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ –ø–∞—Ç–µ—Ä–Ω—É
- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î `pattern_segment_decision` ("buy" –∞–±–æ "not")
- –í–∏–∫–æ–Ω—É—î –º–Ω–æ–∂–∏–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ (liquidity withdrawal, post-entry drop, MIN_TX_COUNT, MIN_SELL_SHARE)

**–©–æ –∑–∞–ø–∏—Å—É—î:**
```sql
UPDATE tokens SET
    pattern_segment_1 = $2,
    pattern_segment_2 = $3,
    pattern_segment_3 = $4,
    pattern_segment_decision = $5
WHERE id = $1
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
1. **Liquidity withdrawal** (—Ä—è–¥–∫–∏ 285-315):
   - –í–∏–∫–ª–∏–∫–∞—î `_detect_liquidity_withdraw()`
   - –Ø–∫—â–æ –≤–∏—è–≤–ª–µ–Ω–æ ‚Üí `decision = "not"`

2. **Post-entry drop** (—Ä—è–¥–∫–∏ 324-378):
   - –í–∏–∫–ª–∏–∫–∞—î `_detect_post_entry_drop()`
   - –Ø–∫—â–æ –ø–∞–¥—ñ–Ω–Ω—è >= 15% ‚Üí `decision = "not"`

3. **MIN_TX_COUNT / MIN_SELL_SHARE** (—Ä—è–¥–∫–∏ 380-438):
   - –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è 3-–≥–æ —Å–µ–≥–º–µ–Ω—Ç—É (170s)
   - –Ø–∫—â–æ `total_tx < MIN_TX_COUNT` ‚Üí `decision = "not"`
   - –Ø–∫—â–æ `sell_share < MIN_SELL_SHARE` ‚Üí `decision = "not"`

4. **Freeze decision** (—Ä—è–¥–∫–∏ 440-489):
   - –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –¥–æ—Å—è–≥ `AUTO_BUY_ENTRY_SEC` —ñ `decision = "not"` –ë–ï–ó –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
   - –ó–∞–º–æ—Ä–æ–∂—É—î —Ä—ñ—à–µ–Ω–Ω—è —è–∫ "not" (–Ω–µ –¥–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ "buy" –ø—ñ—Å–ª—è —Ç–æ—á–∫–∏ –≤—Ö–æ–¥—É)

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå **–ù–ï –ê–†–•–Ü–í–£–Ñ** (—Ç—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î `decision`)

---

### `get_tokens_batch(self)` (—Ä—è–¥–∫–∏ 512-592)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –û—Ç—Ä–∏–º—É—î –±–∞—Ç—á —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –æ–±—Ä–æ–±–∫–∏
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î round-robin –¥–ª—è —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ–≥–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—É
- –§—ñ–ª—å—Ç—Ä—É—î —Ç—ñ–ª—å–∫–∏ —Ç–æ–∫–µ–Ω–∏ –∑ `history_ready = FALSE`

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ —á–∏—Ç–∞–Ω–Ω—è)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤
- `history_ready = FALSE`

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `get_jupiter_data(tokens)` (—Ä—è–¥–∫–∏ 594-644)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –†–æ–±–∏—Ç—å HTTP –∑–∞–ø–∏—Ç –¥–æ Jupiter API –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ç–æ–∫–µ–Ω–∏
- –û–±–º–µ–∂—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–¥—Ä–µ—Å –¥–æ 70 (hard cap)
- –û–±—Ä–æ–±–ª—è—î rate limiting (Retry-After header)

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ HTTP –∑–∞–ø–∏—Ç)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- HTTP —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `save_token_data(token_id, data)` (—Ä—è–¥–∫–∏ 646-1367)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- **–ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø:** –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –∑ Jupiter API –≤ –ë–î
- –û–Ω–æ–≤–ª—é—î –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ–∫–µ–Ω–∞
- –ó–∞–ø–∏—Å—É—î —Å–µ–∫—É–Ω–¥–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ –≤ `token_metrics_seconds`
- –í–∏–∫–ª–∏–∫–∞—î `_update_segment_predictions()` –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –ø–∞—Ç–µ—Ä–Ω—ñ–≤
- –í–∏–∫–æ–Ω—É—î –º–Ω–æ–∂–∏–Ω—É "guard" –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ (rug pull, auto-sell, auto-buy, bad patterns, archiving)

**–©–æ –∑–∞–ø–∏—Å—É—î:**
1. **–û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ —Ç–æ–∫–µ–Ω–∞** (—Ä—è–¥–∫–∏ 661-686):
   ```sql
   UPDATE tokens SET
       name, symbol, icon, decimals, dev,
       circ_supply, total_supply, token_program, holder_count,
       usd_price, liquidity, fdv, mcap, price_block_id,
       organic_score, organic_score_label
   WHERE id = $1
   ```

2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä—ñ–æ–¥–∞—Ö** (—Ä—è–¥–∫–∏ 688-719):
   - `price_change_5m`, `holder_change_5m`, `liquidity_change_5m`, ...
   - –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–ª—è `1h`, `6h`, `24h`

3. **Audit –¥–∞–Ω—ñ** (—Ä—è–¥–∫–∏ 721-738):
   - `mint_authority_disabled`, `freeze_authority_disabled`, `top_holders_percentage`, ...

4. **–°–µ–∫—É–Ω–¥–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏** (—Ä—è–¥–∫–∏ 805-820):
   ```sql
   INSERT INTO token_metrics_seconds (
       token_id, ts, usd_price, liquidity, fdv, mcap, price_block_id, jupiter_slot, holder_count
   ) VALUES (...)
   ON CONFLICT (token_id, ts) DO UPDATE SET ...
   ```

5. **Buy/sell counts** (—Ä—è–¥–∫–∏ 829-837):
   ```sql
   UPDATE token_metrics_seconds
   SET buy_count = $3, sell_count = $4
   WHERE token_id = $1 AND ts = $2
   ```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**

#### 1. **Rug/Drained-Liquidity Guard** (—Ä—è–¥–∫–∏ 881-975)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –û—Å—Ç–∞–Ω–Ω—ñ N —Å–µ–∫—É–Ω–¥ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 20) –º–∞—é—Ç—å zero/NULL —Ü—ñ–Ω—É/mcap –ê–ë–û
- –í–∏—è–≤–ª–µ–Ω–æ flat —Ü—ñ–Ω—É/mcap —á–µ—Ä–µ–∑ `_detect_liquidity_withdraw()`

**–õ–æ–≥—ñ–∫–∞:**
```python
if (total >= zero_tail and pos_cnt == 0) or is_flat:
    open_position = await conn.fetchrow(
        "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
    )
    
    if open_position:
        # ‚úÖ –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –∑–∞–∫—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ finalize_token_sale()
        await finalize_token_sale(token_id, conn, reason='zero_liquidity')
    else:
        # ‚ùå –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
        await archive_token(token_id, conn=conn)
```

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
- –Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –≤–∏–∫–ª–∏–∫–∞—î `finalize_token_sale()` (–∑–∞–∫—Ä–∏–≤–∞—î –ø–æ–∑–∏—Ü—ñ—é)
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É—î

---

#### 2. **AUTO-SELL Guard** (—Ä—è–¥–∫–∏ 979-1048)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è –≤ `wallet_history`
- –ü–æ—Ç–æ—á–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è >= `entry_amount_usd * (1 + TARGET_RETURN)`

**–õ–æ–≥—ñ–∫–∞:**
```python
position_row = await conn.fetchrow(
    "SELECT entry_token_amount, entry_amount_usd FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
)

if position_row:
    current_portfolio_value = entry_token_amount * current_price
    target_value = entry_amount_usd * (1.0 + target_return)
    
    if current_portfolio_value >= target_value:
        # –í–∏–∫–ª–∏–∫–∞—î sell_real() –≤ background task
        asyncio.create_task(_auto_sell_task())
```

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ (–≤–∏–∫–ª–∏–∫–∞—î `sell_real()` —è–∫–∏–π –∑–∞–ø–∏—Å—É—î –≤ `wallet_history`)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
- –ü–æ—Ç–æ—á–Ω—É —Ü—ñ–Ω—É —Ç–æ–∫–µ–Ω–∞
- –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ–≥–æ –ø—Ä–∏–±—É—Ç–∫—É

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î (—Ç—ñ–ª—å–∫–∏ –≤–∏–∫–ª–∏–∫–∞—î –ø—Ä–æ–¥–∞–∂)

---

#### 3. **Corridor Guard** (—Ä—è–¥–∫–∏ 1050-1056)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –í–∏–∫–ª–∏–∫–∞—î `_apply_price_corridor_guard()` —è–∫–∏–π –ø–µ—Ä–µ–≤—ñ—Ä—è—î brutal dumps

**–õ–æ–≥—ñ–∫–∞:**
- –î–∏–≤. `_apply_price_corridor_guard()` –Ω–∏–∂—á–µ

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –≤ `_apply_price_corridor_guard()`

---

#### 4. **AUTO-BUY Guard** (—Ä—è–¥–∫–∏ 1060-1162)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –Ñ —É–≤—ñ–º–∫–Ω–µ–Ω—ñ –∫–æ—à–µ–ª—å–∫–∏ (`entry_amount_usd > 0`)
- –¢–æ–∫–µ–Ω –¥–æ—Å—è–≥ `AUTO_BUY_ENTRY_SEC` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 171 —Å–µ–∫—É–Ω–¥–∞)
- –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó (`exit_iteration IS NULL`)
- `pattern_segment_decision = "buy"`
- –°–µ–≥–º–µ–Ω—Ç–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –≤—Ö—ñ–¥ (`_segments_allow_entry()`)
- `total_tx >= MIN_TX_COUNT`
- `sell_share >= MIN_SELL_SHARE`
- `latest_price > 0`

**–õ–æ–≥—ñ–∫–∞:**
```python
auto_buy_check = await conn.fetchrow(
    """
    WITH no_entry AS (
        SELECT NOT EXISTS (
            SELECT 1 FROM wallet_history 
            WHERE token_id=$1 AND exit_iteration IS NULL
        ) AS none
    )
    SELECT ... FROM no_entry WHERE no_entry.none = TRUE
    """
)

if auto_buy_check and decision_flag == "buy" and ...:
    # –í–∏–∫–ª–∏–∫–∞—î buy_real() –≤ background task
    asyncio.create_task(_auto_buy_task())
```

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ (–≤–∏–∫–ª–∏–∫–∞—î `buy_real()` —è–∫–∏–π –∑–∞–ø–∏—Å—É—î –≤ `wallet_history`)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —É–≤—ñ–º–∫–Ω–µ–Ω–∏—Ö –∫–æ—à–µ–ª—å–∫—ñ–≤
- –í—ñ–∫ —Ç–æ–∫–µ–Ω–∞ (iterations >= AUTO_BUY_ENTRY_SEC)
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
- AI decision = "buy"
- –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ñ–≤
- –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
- –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—É —á–∞—Å—Ç–∫—É –ø—Ä–æ–¥–∞–∂—ñ–≤

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î (—Ç—ñ–ª—å–∫–∏ –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–∫—É–ø–∫—É)

---

#### 5. **Bad Pattern Guard** (—Ä—è–¥–∫–∏ 1164-1243)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –¢–æ–∫–µ–Ω –º–∞—î bad pattern (`black_hole`, `flatliner`, `rug_prequel`, ...)
- –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó (`no_entry.none = TRUE`)
- –î–æ—Å—Ç–∞—Ç–Ω—å–æ —ñ—Ç–µ—Ä–∞—Ü—ñ–π (`>= BAD_PATTERN_HISTORY_READY_ITERS`, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 100)

**–õ–æ–≥—ñ–∫–∞:**
```python
pattern_check = await conn.fetchrow(
    """
    WITH no_entry AS (
        SELECT NOT EXISTS (
            SELECT 1 FROM wallet_history WHERE token_id=$1
        ) AS none
    )
    SELECT ... WHERE no_entry.none = TRUE AND pattern_code = ANY($2)
    """
)

if pattern_check:
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ü–ï–†–ï–î –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
    open_pos_check = await conn.fetchrow(
        "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
    )
    
    if not open_pos_check:
        # ‚ùå –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
        await archive_token(token_id, conn=conn)
    else:
        # ‚úÖ –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏, —Ç—ñ–ª—å–∫–∏ history_ready = TRUE
        await conn.execute("UPDATE tokens SET history_ready = TRUE WHERE id=$1")
```

**–©–æ –∑–∞–ø–∏—Å—É—î:**
```sql
UPDATE tokens SET history_ready = TRUE WHERE id = $1
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å bad pattern
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó (–≤ SQL –∑–∞–ø–∏—Ç—ñ)
- **–ö–†–ò–¢–ò–ß–ù–û:** –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó –ü–ï–†–ï–î –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É—î
- –Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`

---

#### 6. **Bad Decision (NOT) Guard** (—Ä—è–¥–∫–∏ 1245-1320)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- `pattern_segment_decision = "not"`
- –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó (`no_entry.none = TRUE`)
- –î–æ—Å—Ç–∞—Ç–Ω—å–æ —ñ—Ç–µ—Ä–∞—Ü—ñ–π (`>= BAD_PATTERN_HISTORY_READY_ITERS`, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 480)

**–õ–æ–≥—ñ–∫–∞:**
```python
decision_check = await conn.fetchrow(
    """
    WITH no_entry AS (
        SELECT NOT EXISTS (
            SELECT 1 FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL
        ) AS none
    )
    SELECT ... WHERE no_entry.none = TRUE AND decision = 'not'
    """
)

if decision_check:
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ü–ï–†–ï–î –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
    open_pos_check = await conn.fetchrow(
        "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
    )
    
    if not open_pos_check:
        # ‚ùå –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
        await archive_token(token_id, conn=conn)
    else:
        # ‚úÖ –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏, —Ç—ñ–ª—å–∫–∏ history_ready = TRUE
        await conn.execute("UPDATE tokens SET history_ready = TRUE WHERE id=$1")
```

**–©–æ –∑–∞–ø–∏—Å—É—î:**
```sql
UPDATE tokens SET history_ready = TRUE WHERE id = $1
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- `pattern_segment_decision = "not"`
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó (–≤ SQL –∑–∞–ø–∏—Ç—ñ)
- **–ö–†–ò–¢–ò–ß–ù–û:** –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó –ü–ï–†–ï–î –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É—î
- –Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`

---

#### 7. **ETA_MAX_TOKEN_AGE_SEC Guard** (—Ä—è–¥–∫–∏ 1322-1359)

**–£–º–æ–≤–∞ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:**
- –¢–æ–∫–µ–Ω –º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é
- –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–≤–∏—â–∏–≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –≤—ñ–∫ (`iterations >= ETA_MAX_TOKEN_AGE_SEC`, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 480 —Å–µ–∫—É–Ω–¥)

**–õ–æ–≥—ñ–∫–∞:**
```python
age_check = await conn.fetchrow(
    """
    WITH has_open_pos AS (
        SELECT EXISTS (
            SELECT 1 FROM wallet_history 
            WHERE token_id=$1 AND exit_iteration IS NULL
        ) AS exists_pos
    )
    SELECT ... WHERE iterations >= $2 AND has_open_pos.exists_pos = TRUE
    """
)

if age_check:
    # ‚úÖ –ó–∞–∫—Ä–∏–≤–∞—î –ø–æ–∑–∏—Ü—ñ—é —á–µ—Ä–µ–∑ finalize_token_sale()
    await finalize_token_sale(token_id, conn, reason='max_age_timeout')
```

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ (–≤–∏–∫–ª–∏–∫–∞—î `finalize_token_sale()` —è–∫–∏–π –∑–∞–ø–∏—Å—É—î –≤ `wallet_history`)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
- –ü–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫—É

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ù–ï –∞—Ä—Ö—ñ–≤—É—î, –∞ –∑–∞–∫—Ä–∏–≤–∞—î –ø–æ–∑–∏—Ü—ñ—é —á–µ—Ä–µ–∑ `finalize_token_sale()`

---

### `_get_corridor_windows(self)` (—Ä—è–¥–∫–∏ 1369-1409)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –≤—ñ–∫–æ–Ω –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ corridor drops
- –ù–∞–ª–∞—à—Ç–æ–≤—É—î –¥–≤–∞ –≤—ñ–∫–Ω–∞: "pre" (75-85s) —Ç–∞ "final" (115-125s)

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Ç—ñ–ª—å–∫–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å `PRICE_CORRIDOR_GUARD_ENABLED` –≤ config

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_calc_window_drop_recovery(prices, start_iter, end_iter)` (—Ä—è–¥–∫–∏ 1411-1439)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –û–±—á–∏—Å–ª—é—î –≤—ñ–¥—Å–æ—Ç–æ–∫ –ø–∞–¥—ñ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –≤—ñ–∫–Ω—ñ
- –ó–Ω–∞—Ö–æ–¥–∏—Ç—å peak –¥–æ –≤—ñ–∫–Ω–∞ —Ç–∞ trough –≤ –≤—ñ–∫–Ω—ñ
- –û–±—á–∏—Å–ª—é—î recovery —è–∫ –≤—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ trough –¥–æ –∫—ñ–Ω—Ü—è –≤—ñ–∫–Ω–∞

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ (—Å—Ç–∞—Ç–∏—á–Ω–∏–π –º–µ—Ç–æ–¥, —Ç—ñ–ª—å–∫–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—å–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `_flag_corridor_drop(conn, token_id, label, stage, drop_pct, recovery_pct)` (—Ä—è–¥–∫–∏ 1441-1482)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ü–æ–∑–Ω–∞—á–∞—î —Ç–æ–∫–µ–Ω —è–∫ "corridor drop" (brutal dump)
- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î `history_ready = TRUE` —Ç–∞ `pattern_code = label`

**–©–æ –∑–∞–ø–∏—Å—É—î:**
```sql
UPDATE tokens SET
    history_ready = TRUE,
    pattern_code = $2,
    token_updated_at = CURRENT_TIMESTAMP
WHERE id = $1 AND history_ready = FALSE
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- **–ö–†–ò–¢–ò–ß–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ü–ï–†–ï–î –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é:
```python
open_pos_check = await conn.fetchrow(
    "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
)

if not open_pos_check:
    # ‚ùå –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    await archive_token(token_id, conn=conn)
else:
    # ‚úÖ –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏
    # (—Ç—ñ–ª—å–∫–∏ history_ready = TRUE –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤–∏—â–µ)
```

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –∞—Ä—Ö—ñ–≤—É—î
- –Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`

---

### `_apply_price_corridor_guard(conn, token_id)` (—Ä—è–¥–∫–∏ 1484-1546)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î brutal dumps –≤ –∫–æ—Ä–∏–¥–æ—Ä–∞—Ö (pre: 75-85s, final: 115-125s)
- –í–∏–∫–ª–∏–∫–∞—î `_flag_corridor_drop()` —è–∫—â–æ –≤–∏—è–≤–ª–µ–Ω–æ drop >= threshold –∑ –Ω–∏–∑—å–∫–∏–º recovery

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ (–≤–∏–∫–ª–∏–∫–∞—î `_flag_corridor_drop()`)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- **–ö–†–ò–¢–ò–ß–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ù–ê –ü–û–ß–ê–¢–ö–£:
```python
open_position = await conn.fetchrow(
    "SELECT 1 FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
)

if open_position:
    # ‚úÖ –Ñ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ù–ï –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ corridor, –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ False
    return False
```

- –ù–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—å–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ—á–æ–∫
- Drop percentage >= threshold
- Recovery percentage < minimum

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚úÖ **–ó–ê–•–ò–©–ï–ù–û:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –Ω–∞ –ø–æ—á–∞—Ç–∫—É
- –Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î `False` (–Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î corridor)
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—è—î corridor —ñ –≤–∏–∫–ª–∏–∫–∞—î `_flag_corridor_drop()` (—è–∫–∏–π —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø–æ–∑–∏—Ü—ñ—é)

---

### `_scan_loop(self)` (—Ä—è–¥–∫–∏ 1548-1587)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ì–æ–ª–æ–≤–Ω–∏–π —Ü–∏–∫–ª –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä–∞
- –ö–æ–∂–Ω—ñ `scan_interval` —Å–µ–∫—É–Ω–¥ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 3):
  1. –û—Ç—Ä–∏–º—É—î –±–∞—Ç—á —Ç–æ–∫–µ–Ω—ñ–≤ —á–µ—Ä–µ–∑ `get_tokens_batch()`
  2. –û—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ –∑ Jupiter —á–µ—Ä–µ–∑ `get_jupiter_data()`
  3. –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ `save_token_data()`

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ (–≤–∏–∫–ª–∏–∫–∞—î —ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –ù–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤
- –°—Ç–∞—Ç—É—Å Jupiter API

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

### `start(self)` / `stop(self)` (—Ä—è–¥–∫–∏ 1589-1598)

**–©–æ —Ä–æ–±–∏—Ç—å:**
- `start()`: –ó–∞–ø—É—Å–∫–∞—î `_scan_loop()` –≤ background task
- `stop()`: –ó—É–ø–∏–Ω—è—î `_scan_loop()`

**–©–æ –∑–∞–ø–∏—Å—É—î:**
- –ù—ñ—á–æ–≥–æ

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
- –°—Ç–∞–Ω `is_scanning`

**–ê—Ä—Ö—ñ–≤–∞—Ü—ñ—è:**
- ‚ùå –ù–µ–º–∞—î

---

## üîí –ó–∞—Ö–∏—Å—Ç –í—ñ–¥ –ê—Ä—Ö—ñ–≤–∞—Ü—ñ—ó –¢–æ–∫–µ–Ω—ñ–≤ –ó –í—ñ–¥–∫—Ä–∏—Ç–∏–º–∏ –ü–æ–∑–∏—Ü—ñ—è–º–∏

### ‚úÖ –ú—ñ—Å—Ü—è, –î–µ –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –í—ñ–¥–∫—Ä–∏—Ç–∞ –ü–æ–∑–∏—Ü—ñ—è:

1. **Rug/Drained-Liquidity Guard** (—Ä—è–¥–æ–∫ 937):
   ```python
   open_position = await conn.fetchrow(
       "SELECT id FROM wallet_history WHERE token_id=$1 AND exit_iteration IS NULL"
   )
   if open_position:
       await finalize_token_sale(...)  # –ó–∞–∫—Ä–∏–≤–∞—î –ø–æ–∑–∏—Ü—ñ—é
   else:
       await archive_token(...)  # –ê—Ä—Ö—ñ–≤—É—î
   ```

2. **Bad Pattern Guard** (—Ä—è–¥–æ–∫ 1201):
   ```python
   open_pos_check = await conn.fetchrow(...)
   if not open_pos_check:
       await archive_token(...)  # –ê—Ä—Ö—ñ–≤—É—î
   else:
       # –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ history_ready = TRUE
   ```

3. **Bad Decision (NOT) Guard** (—Ä—è–¥–æ–∫ 1280):
   ```python
   open_pos_check = await conn.fetchrow(...)
   if not open_pos_check:
       await archive_token(...)  # –ê—Ä—Ö—ñ–≤—É—î
   else:
       # –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ history_ready = TRUE
   ```

4. **Corridor Guard** (—Ä—è–¥–æ–∫ 1491):
   ```python
   open_position = await conn.fetchrow(...)
   if open_position:
       return False  # –ù–ï –ø–µ—Ä–µ–≤—ñ—Ä—è—î corridor
   ```

5. **`_flag_corridor_drop()`** (—Ä—è–¥–æ–∫ 1446):
   ```python
   open_pos_check = await conn.fetchrow(...)
   if not open_pos_check:
       await archive_token(...)  # –ê—Ä—Ö—ñ–≤—É—î
   else:
       # –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ history_ready = TRUE
   ```

### ‚ùå –ú—ñ—Å—Ü—è, –î–µ –ù–ï –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –í—ñ–¥–∫—Ä–∏—Ç–∞ –ü–æ–∑–∏—Ü—ñ—è:

**–ù–ï–ú–ê–Ñ!** –í—Å—ñ –º—ñ—Å—Ü—è –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é.

---

## üìä –ü–æ—Ä—è–¥–æ–∫ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –í `save_token_data()`

1. **–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–æ–∫–µ–Ω–∞** (—Ä—è–¥–∫–∏ 661-787)
2. **–ó–∞–ø–∏—Å —Å–µ–∫—É–Ω–¥–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫** (—Ä—è–¥–∫–∏ 790-872)
3. **–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–≥–º–µ–Ω—Ç–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤** (—Ä—è–¥–æ–∫ 841) ‚Üí –≤–∏–∫–ª–∏–∫–∞—î `_update_segment_predictions()`
4. **Rug/Drained-Liquidity Guard** (—Ä—è–¥–∫–∏ 881-975)
5. **AUTO-SELL Guard** (—Ä—è–¥–∫–∏ 979-1048)
6. **Corridor Guard** (—Ä—è–¥–∫–∏ 1050-1056)
7. **AUTO-BUY Guard** (—Ä—è–¥–∫–∏ 1060-1162)
8. **Bad Pattern Guard** (—Ä—è–¥–∫–∏ 1164-1243)
9. **Bad Decision (NOT) Guard** (—Ä—è–¥–∫–∏ 1245-1320)
10. **ETA_MAX_TOKEN_AGE_SEC Guard** (—Ä—è–¥–∫–∏ 1322-1359)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–Ü –ú–û–ú–ï–ù–¢–ò

### ‚úÖ –ó–∞—Ö–∏—Å—Ç –ü—Ä–∞—Ü—é—î –ü—Ä–∞–≤–∏–ª—å–Ω–æ:

1. **–í—Å—ñ –º—ñ—Å—Ü—è –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é**
2. **–Ø–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –ø–æ–∑–∏—Ü—ñ—è:**
   - Rug pull ‚Üí –∑–∞–∫—Ä–∏–≤–∞—î —á–µ—Ä–µ–∑ `finalize_token_sale()`
   - Bad pattern ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`
   - Bad decision ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`
   - Corridor drop ‚Üí –ù–ï –∞—Ä—Ö—ñ–≤—É—î, —Ç—ñ–ª—å–∫–∏ `history_ready = TRUE`
   - Max age ‚Üí –∑–∞–∫—Ä–∏–≤–∞—î —á–µ—Ä–µ–∑ `finalize_token_sale()`

3. **–Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó:**
   - –í—Å—ñ guard'–∏ –º–æ–∂—É—Ç—å –∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω

### üîç –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –ü—Ä–æ–±–ª–µ–º–∏:

1. **Race condition:** –Ø–∫—â–æ `force buy` –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑ `save_token_data()`, –º–æ–∂–ª–∏–≤–∞ —Å–∏—Ç—É–∞—Ü—ñ—è:
   - `save_token_data()` –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø–æ–∑–∏—Ü—ñ—é ‚Üí –Ω–µ–º–∞—î
   - `force buy` —Å—Ç–≤–æ—Ä—é—î –ø–æ–∑–∏—Ü—ñ—é
   - `save_token_data()` –∞—Ä—Ö—ñ–≤—É—î —Ç–æ–∫–µ–Ω
   
   **–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è atomic locking –≤ `buy_real()` —á–µ—Ä–µ–∑ `SELECT ... FOR UPDATE`

2. **SQL –∑–∞–ø–∏—Ç–∏ –∑ `no_entry`:** –î–µ—è–∫—ñ guard'–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å SQL `NOT EXISTS` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø–æ–∑–∏—Ü—ñ—ó, –∞–ª–µ –ø–æ—Ç—ñ–º —Ä–æ–±–ª—è—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é. –¶–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞–ª–µ –º–æ–∂–µ –±—É—Ç–∏ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ.

---

## üìù –í–∏—Å–Ω–æ–≤–æ–∫

**–í—Å—ñ –º—ñ—Å—Ü—è –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–æ–∑–∏—Ü—ñ—é –ø–µ—Ä–µ–¥ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—î—é.**

–¢–æ–∫–µ–Ω–∏ –∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º–∏ –ø–æ–∑–∏—Ü—ñ—è–º–∏ (–≤–∫–ª—é—á–∞—é—á–∏ `force buy`) **–ù–ï –ë–£–î–£–¢–¨** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω—ñ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏:
- –ú–∞—é—Ç—å bad pattern
- –ú–∞—é—Ç—å `decision = "not"`
- –í–∏—è–≤–ª–µ–Ω–æ corridor drop
- –í–∏—è–≤–ª–µ–Ω–æ rug pull (–∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `finalize_token_sale()`)

**–Ñ–¥–∏–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è, –∫–æ–ª–∏ —Ç–æ–∫–µ–Ω –∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –ø–æ–∑–∏—Ü—ñ—î—é –º–æ–∂–µ –±—É—Ç–∏ "–∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏–π":**
- `ETA_MAX_TOKEN_AGE_SEC` timeout ‚Üí –∞–ª–µ —Ü–µ –Ω–µ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è, –∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó —á–µ—Ä–µ–∑ `finalize_token_sale()`

